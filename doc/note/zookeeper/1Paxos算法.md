要说zk，就要说一下分布式一致性。

分布式一致性， 锁归属。


什么是分布式一致性：
集群中状态机的一致性。

一致性：强一致性，做不到
顺序一致性，        同一个读写操作的集合所有进程看到的都是一样的顺序， 典型的是死锁中的样子。
因果一致性，保证有因果关系的一致性。
最终一次性。  保证客户角度的一致性。

|  1   | Backups     | M/S	     | MM           | 2PC           | Paxos  |
| ---------- |:----------:|:----------:|:----------:|:----------:| -----:|
| Consistency(一致性) | Weak.
因为一般都是定时策略，所以会有很长时间的不一致 | 最终一致性 | 最终一致性 | Strong | Strong |
| Transaction(事务) | 不支持 | Full | Local  | Full | Full |
| Latency(延时) | 高  | 低 | 低 | 高 | 高 |
| throughput(吞吐量) | 高  | 高 | 高 | 低 | 中等 |
| Data loss | lots  | Some | Some | None | None |
| Failover | Down  | Read only | R/W | R/W | R/W |

2pc
节点的角色：  协调者(通常只有一个)， 参与者(多个)。
一个状态变更 -> 所有状态机一致之后的一个过程。分成两个阶段：
1. 请求阶段。  协调者 用变更去询问所有的参与者， 并且拿到所有参与者的返回，参与者只能选择(Yes 还是No) 进入这个阶段之后参与者本身会记录状态，且处于阻塞。
2. 提交阶段。    
    协调者看结果，如果有一个不同意，那么告诉所有的节点回滚。  都同意的话，那么通知执行。

2PC除了有效率的问题，还有一个问题是节点故障的时候无法继续工作。

1，协调者出错，参与者也出错；

2，协调者出错，参与者不出错；

3，协调者不出错，参与者出错；

4，协调者不出错，参与者也不出错。

日志降低性能。



3PC。不确定状态与回滚。



Paxos.
节点的角色： Proposer 提议者和Acceptor 批注者。
    完成一次算法之前： 所有Acceptor的状态一致。 
        好了开始：
            第一个阶段：Prepare阶段：
                a) proposer 发出 repare请求给各个节点。 发送的数据为：{"sn": n}.
                        acceptor 当本地没有同意过请求呢，那么就返回OK。
                        acceptor查看上一次同意的，本地的值是 {"sn":j, "value":v1}，那么如果j>n那么就忽略掉。        如果n>=j那么就回复一下： {"sn":j, "value":v1} ，且承诺不会同意编号<n的决议
           第二阶段： accept批准阶段。
                a) 如果发现多数的有返回，
                        a1)返回中多数为OK，则设置一个自己的值。 v2， 发出accept请求{"sn":n, "value": v2}
                        a2) 返回中有各种各样的值，那么选编号最大的，发出accept请求 {"sn":x, "value":vx}
                b) 如果对于accept的请求满足多个，那么确认v被接收了。算法完成一次，且通知learn进行学习。
                        否则，proposer从头开始再搞
                简单描述下，就是先学习提案的内容，如果都还没内容，那么accept自己的内容，学习完之后选编号最大的accept， 如果accept通过的人站大多数，那么算法就完了，通知给所有人学习。
        
            有个缺陷是：收敛慢， 会死锁。(第二阶段的时候不停的加)  
                    不能修改v值
                    不保证先发起的提案先被接收。

Simple poxos
        为了解决这个问题。    引入了Leader， 同时只能有一个leader. 只有leader能够提出提案。
        开始一次算法的时候。
        leader 发起同步，收集信息，
        然后选择最新的议案accept， accept通过之后广播出去。




https://yq.aliyun.com/articles/2709
http://cailin.iteye.com/blog/2014486/


http://ifeve.com/zookeeper-leader/
http://www.superwu.cn/2014/11/26/1461/


